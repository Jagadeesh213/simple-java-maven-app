node {

stage (‘Prepare environment’) {

git branch: ‘development’, url: ‘https://github.com/Jagadeesh213/simple-java-maven-app.git’

sh ‘npm install’

}

stage (‘Code analyse’) {

sh ‘echo “Run some lints”’

}

stage (‘Unit test’) {

sh ‘echo “Tests will back”’

}

stage (‘Build’) {

sh ‘npm run clean’

sh ‘npm run build’

}

}

withCredentials([sshUserPrivateKey(
    credentialsId: 'server', 
    usernameVariable: 'USER', 
    keyFileVariable: 'KEY_FILE'),
    string(credentialsId: 'server-ip', variable: 'EC2_IP')
]) {
    def remote = [:]
    remote.name = USER
    remote.host = EC2_IP
    remote.user = USER
    remote.identityFile = KEY_FILE
    remote.allowAnyHosts = true
    sshCommand remote: remote, command: "pwd"
}

stage('Deploy') {
  agent any
  steps {
    sh 'mv sample/webapp/target/webapp.war webapp.war'
    sshPublisher(
      continueOnError: false, 
      failOnError: true,
      publishers: [
        sshPublisherDesc(
          configName: "my-ssh-connection",
          transfers: [sshTransfer(sourceFiles: 'webapp.war')],
          verbose: true
        )
      ]
    )
  }
}
